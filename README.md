# ESA 反向代理部署指南

这是一个可以部署在阿里云 ESA（边缘安全加速）平台上的反向代理应用。

## 📁 项目文件

```
qoder/
├── index.html          # 前端页面（提供 URL 输入界面）
├── edge-function.js    # ESA 边缘函数（处理反向代理逻辑）
└── README.md          # 部署说明
```

## 🚀 部署步骤

### 方式一：通过 ESA Pages 部署

1. **登录阿里云 ESA 控制台**
   - 访问：https://esa.console.aliyun.com/

2. **创建 Pages 应用**
   - 进入「Pages」页面
   - 点击「创建应用」
   - 选择「直接上传」或「Git 仓库」

3. **上传文件**
   - 将 `index.html` 上传为静态页面
   - 配置构建设置（如果需要）

4. **配置边缘函数**
   - 进入「边缘函数」管理
   - 创建新函数，将 `edge-function.js` 的内容粘贴进去
   - 设置触发路由：
     - 路由路径：`/proxy*`
     - 匹配模式：前缀匹配

5. **发布应用**
   - 点击「发布」按钮
   - 等待部署完成
   - 获取访问域名

### 方式二：通过 ESA 边缘函数独立部署

1. **创建边缘函数**
   - 登录 ESA 控制台
   - 进入「边缘函数」
   - 点击「创建函数」

2. **配置函数代码**
   - 复制 `edge-function.js` 的全部内容
   - 粘贴到函数编辑器中

3. **配置触发规则**
   - 添加路由：
     - `/` - 返回主页（index.html）
     - `/proxy` - 处理代理请求

4. **上传静态资源**
   - 在 ESA 的「资源管理」中上传 `index.html`
   - 或者使用 CDN 托管静态页面

5. **绑定域名**
   - 在 ESA 控制台绑定自定义域名
   - 配置 HTTPS 证书（建议）

## ⚙️ 配置说明

### 边缘函数配置

如果需要自定义配置，可以在 `edge-function.js` 中修改：

```javascript
// 允许的协议
if (target.protocol !== 'http:' && target.protocol !== 'https:') {
  // 可以添加其他协议支持
}

// User-Agent 设置
headers.set('User-Agent', 'Mozilla/5.0 ...')
```

### 安全设置

默认已包含以下安全措施：
- ✅ 只允许 HTTP/HTTPS 协议
- ✅ URL 格式验证
- ✅ CORS 跨域处理
- ✅ 移除限制性安全头

如需增强安全性，可以添加：

```javascript
// 限制访问的域名白名单
const allowedDomains = ['example.com', 'trusted-site.com']
if (!allowedDomains.includes(target.host)) {
  return new Response('不允许访问该域名', { status: 403 })
}
```

## 📖 使用方法

1. 访问部署后的网站
2. 在输入框中输入完整的 URL（如：`https://example.com`）
3. 点击「访问」按钮
4. 系统将通过 ESA 边缘节点代理访问目标网站

## 🔧 功能特性

- ✨ 简洁美观的用户界面
- 🚀 通过 ESA 边缘节点加速访问
- 🔒 隐藏真实访问来源，保护隐私
- 🌐 支持任意 HTTP/HTTPS 网站
- 📱 响应式设计，支持移动端
- 💾 自动记忆上次访问的 URL
- 🔄 自动处理相对路径资源（HTML 页面）

## ⚠️ 注意事项

1. **资源限制**
   - ESA 边缘函数有执行时间限制（通常 30-50ms）
   - 大文件下载可能受到限制

2. **内容处理**
   - HTML 内容会自动重写资源路径
   - JavaScript 动态加载的资源可能需要额外处理
   - 某些网站可能有反代理措施

3. **合规使用**
   - 请遵守目标网站的使用条款
   - 不要用于非法用途
   - 注意版权和隐私保护

4. **性能优化**
   - 可以配置 ESA 缓存策略提高性能
   - 建议为静态资源设置缓存

## 🛠️ 故障排查

### 问题：无法访问某些网站

**解决方案：**
- 检查目标网站是否可访问
- 查看 ESA 函数日志
- 确认目标网站没有反代理措施

### 问题：页面样式丢失

**解决方案：**
- 检查 HTML 重写逻辑
- 查看浏览器控制台错误
- 某些网站的资源可能使用动态加载

### 问题：跨域错误

**解决方案：**
- 已在边缘函数中设置 CORS 头
- 确认浏览器控制台的具体错误信息

## 📝 更新日志

### v1.0.0 (2024-12-24)
- ✅ 初始版本发布
- ✅ 基础反向代理功能
- ✅ HTML 路径重写
- ✅ 用户界面
- ✅ 安全验证

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📞 支持

如有问题，请参考：
- [阿里云 ESA 文档](https://help.aliyun.com/product/63506.html)
- [边缘函数开发指南](https://help.aliyun.com/document_detail/377576.html)
